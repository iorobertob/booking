{% extends 'base.html' %}

{% block content %}

<h2>Booking Cart</h2>
<table  id="cartTable" class="table">
    <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col">Name</th>
            <th scope="col">Location</th>
            <th scope="col">Borrow Date</th>
            <th scope="col">Return Date</th>
            <th scope="col">Remove</th>
        </tr>
    </thead>
    <tbody>
            {% for item in items %}
            <tr>
                <th scope="row">{{ loop.index }}</th>
                <td class="clickable-cell">
                  <a href="{{url_for('item_details',item_id=item.id)}}" style="display: block; width: 100%; height: 100%;">
                    {{ item.name }}
                  </a>
                </td>
                <td>{{ item.location }}</td>
                <td>{{ item.borrow_date }}</td>
                <td>{{ item.return_date }}</td>
                <td><a href="{{ url_for('remove_from_cart', item_id=loop.index) }}" class="btn btn-danger btn-sm">Remove</a></td>
            </tr>
            {% endfor %}
    </tbody>
</table>
<form action="{{ url_for('book') }}" method="post" id="cart_form">
    <input type="hidden" id="itemsJSON" name="itemsJSON" value="">
    <input type="hidden" id="from_cart" name="from_cart" value="True">
    <input type="hidden" name="action"  id="formAction" value="book">

    <button type="submit" class="btn btn-success">Book All</button>
</form>
<form action="{{ url_for('remove_from_cart', item_id='all') }}" method="post">
    <button type="submit" class="btn btn-warning">Empty Cart</button>
</form>


{% from 'macros.html' import book_modal %}

{{ book_modal ('3', 'Contact Info', False, item, 'bookingModal', 'booking_form') }}

 <!-- CUSTOM MODAL JS -->
    <script 
    id  = "item_detail_modals_script" 
    src = "{{ url_for('custom_static', filename='js/item_detail_modals.js') }}" 
    data-item_for_cart = '{{ items_for_cart|tojson }}'
    data-action_cart   = "{{ url_for('book_cart') }}"
    data-action_book   = "{{ url_for('book') }}">
    </script>

<script>

    setBorrowerUrl("{{url_for('set_borrower')}}");

    const cart_form    = document.getElementById('cart_form');
    const booking_form = document.getElementById('booking_form');

    $(document).ready(function() {
            $('#cartTable').dataTable({
                responsive:true,
                select: {
                    style: 'os',
                    selector: 'td:first-child'
                },
                pagingType: $(window).width() < 768 ? 'simple' : 'simple_numbers',
                language: {
                    paginate: {
                        previous: "&lt;",
                        next: "&gt;"
                    },
                    emptyTable: "Your cart is empty"
                }
            });

            // TODO: null makes the function use item_for_cart from the template data
            updateJSON(booking_form, null );

    });

    document.addEventListener('DOMContentLoaded', (event) => {

        // Intercept the form submission
        cart_form.addEventListener('submit', function(event) {

            event.preventDefault(); // Prevent the form from submitting       

            var info            = JSON.parse({{borrower_info |tojson|safe}});
            const booking_form  = document.getElementById('booking_form');
            loadBorrowerInfo(booking_form, info[0])

            // TODO: This maybe does not need to be sent to the front end and then back to the back
            const booked_dates = JSON.parse('{{ booked_dates|tojson }}'|| '[]');

            loadBookedDatesInfo(booking_form, booked_dates);
                
            $('#bookingModal').modal('show');

        });
    });

</script>

{% endblock %}