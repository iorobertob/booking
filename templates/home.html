{% extends 'base.html' %}

{% block content %}

<a class="navbar-brand" href="{{ url_for('home') }}">
    <img class="image-brand" src="{{ url_for('static', filename='images/misc_logo_alpha.png') }}" alt="Icon" style="height: 100px;"/>
    
</a>
<a class="navbar-brand" href="{{ url_for('home') }}">
    <h1>MISC's Equipment</h1>
</a>


<div class="mb-3 d-flex flex-column flex-md-row justify-content-center justify-content-md-end align-items-center gap-2 px-3">
    {% if current_user.is_authenticated and current_user.is_admin %}
    <a href="{{ url_for('add_item') }}" class="btn btn-primary booking" style="background-color: #34495e; border: none;">Add Item</a>
    <a href="{{ url_for('edit_item', item_id='1') }}" onclick="deleteSelectedItems('delete')" class="btn btn-primary booking" style="background-color: #34495e; border: none;">Delete Selected</a>
    {% endif %}
    <a href="javascript:void(0);" onclick="bookSelectedItems('book', null)" class="btn btn-primary booking" style="background-color: #34495e; border: none;">Book Selected</a>
</div>
<hr>
<div class ="table-responsive">
    <table id="bookingTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Location</th>
                <th>Status</th>
                <th>Borrower</th>
                <th>Borrower Email</th>
                <th>Borrow Date</th>
                <th>Return Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
                <tr>
                    <td><input class="form-check-input item-checkbox" type="checkbox" value="{{item.id}}" id="checkbox_{{item.id}}"></td>
                    <td class="clickable-cell">
                      <a href="{{url_for('item_details',item_id=item.id)}}" style="display: block; width: 100%; height: 100%;">
                        {{ item.name }}
                      </a>
                    </td>
                    <td>{{ item.location }}</td>
                    <td>{{ availability[loop.index-1] }}</td>
                    <td>{{ bookings[loop.index-1].borrower_name }}</td>
                    <td>{{ bookings[loop.index-1].borrower_email }}</td>
                    <td>{{ bookings[loop.index-1].borrow_date.strftime('%Y-%m-%d') if bookings[loop.index-1].borrow_date else '' }}</td>
                    <td>{{ bookings[loop.index-1].return_date.strftime('%Y-%m-%d') if bookings[loop.index-1].return_date else '' }}</td>
                    <td> 
                        <a href="javascript:void(0);" onclick="bookSelectedItems('book', {{item.id}})" >Book</a>
                    {% if current_user.is_admin %}
                        | <a href="{{ url_for('delete_item', item_id=item.id) }}">Delete</a>
                        | <a href="{{ url_for('edit_item', item_id=item.id) }}">Edit</a>
                    {% endif %}
                </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% from 'macros.html' import book_modal%}

{{ book_modal('1', 'Book Item', False, item, 'bookingModal', 'booking_form') }}

<!-- CUSTOM MODAL JS -->
<script 
id  = "item_detail_modals_script" 
src = "{{ url_for('static', filename='js/item_detail_modals.js') }}" 
data-action_cart   = "{{ url_for('book_cart') }}"
data-action_book   = "{{ url_for('book') }}"></script>

<script>

    $(document).ready(function() {
        $('#bookingTable').dataTable({
            responsive:true,
            select: {
                style: 'os',
                selector: 'td:first-child'
            },
            pagingType: $(window).width() < 768 ? 'simple' : 'simple_numbers',
            language: {
                paginate: {
                    previous: "&lt;",
                    next: "&gt;"
                }
            }
        });
    });

    async function bookSelectedItems(action, item_id) {
        
        // The only form on this page
        let form = document.getElementById("booking_form");

        // Collect all checked checkboxes.
        let checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
        
        let selectedIds;

        // Get the item IDs from each checked item.
        if (item_id == null ){
            selectedIds = Array.from(checkedBoxes).map(box => box.value);

            if (selectedIds.length === 0) {
                // Redirect to the same page with a query parameter to trigger flash
                window.location.href = "/?flash=select_items";
                return;
            }
        }
        else{
            selectedIds = [item_id];
        }
        
        // Convert the array of IDs into a comma-separated string to pass as a query parameter.
        let idsQueryParam = selectedIds.join('&items=');

        const url = "{{ url_for('bulk_details') }}?&items=" + idsQueryParam + "&action=book";
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Response status: ${response.status}`);
            }

            // Wait for the response
            const result = await response.json();

            // Load info from the server
            var info            = JSON.parse({{borrower_info |tojson|safe}});
            const booking_form  = document.getElementById('booking_form');
            var info = JSON.parse({{ borrower_info | tojson | safe }} || '[]');
            if (info.length > 0) {
                loadBorrowerInfo(booking_form, info[0]);
            }

            setBorrowerUrl("{{url_for('set_borrower')}}");
            
            updateJSON(form, result.items);
            
            updateBookedDates(form, result.booked_dates);

            initDatePickers();
            
            $('#bookingModal').modal('show');

        } catch (error) {
            console.error(error.message);
        } 
    }

    function deleteSelectedItems(action){
        // TODO:this seems dangerous here...
        window.location.href = "{{ url_for('book') }}?&items=" + idsQueryParam + "&action=delete";
    }


</script>

{% endblock %}
